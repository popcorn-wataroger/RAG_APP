<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NotebookLM-like RAG Bot</title>
  <style>
    :root{
      --bg:#0b0f19; --panel:#121a2a; --panel2:#0e1524; --bd:#22304a;
      --text:#e8eefc; --muted:#9db0d0; --me:#b5d1ff; --btn:#3b82f6;
      --danger:#ef4444; --ok:#22c55e;
    }
    *{box-sizing:border-box;}
    body{font-family:system-ui, sans-serif;background:var(--bg);color:var(--text);margin:0;}
    .wrap{max-width:1200px;margin:0 auto;padding:18px;}
    .layout{display:grid;grid-template-columns: 360px 1fr; gap:14px; min-height: calc(100vh - 36px);}
    .card{background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:14px;}
    h1{font-size:16px;margin:0 0 10px;}
    h2{font-size:14px;margin:0 0 10px;color:var(--muted);font-weight:700;}
    .muted{color:var(--muted);font-size:12px;}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--bd);border-radius:999px;background:var(--panel2);color:var(--muted);font-size:12px;}
    input[type="text"], textarea, select{
      border:1px solid var(--bd);background:var(--panel2);color:var(--text);
      padding:10px;border-radius:12px;outline:none;
    }
    textarea{width:100%;resize:none;height:74px;}
    button{
      border:0;border-radius:12px;background:var(--btn);color:white;font-weight:800;
      cursor:pointer;padding:12px 14px;
    }
    button.secondary{background:#1f2a44;border:1px solid var(--bd);color:var(--text);font-weight:700;}
    button:disabled{opacity:.55;cursor:not-allowed;}
    .chat{height:60vh;overflow:auto;padding:12px;background:var(--panel2);border-radius:12px;border:1px solid var(--bd);}
    .msg{margin:10px 0;line-height:1.6;white-space:pre-wrap;}
    .me{color:var(--me);}
    .bot{color:var(--text);}
    .sys{color:var(--muted);font-size:12px;}
    .row{display:flex;gap:10px;align-items:center;}
    .stack{display:flex;flex-direction:column;gap:10px;}
    .filebox{border:1px dashed var(--bd);background:var(--panel2);padding:10px;border-radius:12px;}
    input[type="file"]{width:100%;color:var(--muted);}
    ul{margin:0;padding:0 0 0 18px;}
    li{margin:6px 0;}
    .docItem{display:flex;justify-content:space-between;gap:10px;align-items:center;}
    .badge{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--bd);color:var(--muted);}
    .badge.ok{border-color:rgba(34,197,94,.5);color:var(--ok);}
    .badge.ng{border-color:rgba(239,68,68,.5);color:var(--danger);}
    .top{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;}
    code{background:var(--panel2);padding:2px 6px;border-radius:8px;border:1px solid var(--bd);color:var(--text);}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="pill">NotebookLM-like RAG Bot</div>
    <div class="pill">API Base: <input id="apiBase" type="text" value="http://127.0.0.1:8080" style="width:240px;"></div>
  </div>

  <div class="layout">
    <!-- å·¦ï¼šè³‡æ–™ -->
    <div class="card">
      <h1>ğŸ“„ è³‡æ–™</h1>
      <div class="muted">ã¾ãšè³‡æ–™ã‚’è¿½åŠ  â†’ æ¬¡ã«è³ªå•ã€ã®é †ã§ä½¿ã„ã¾ã™ã€‚</div>

      <div style="height:10px"></div>

      <div class="filebox">
        <div class="muted" style="margin-bottom:6px;">è³‡æ–™ã‚’è¿½åŠ ï¼ˆPDF/TXT æ¨å¥¨ã€è¤‡æ•°OKï¼‰</div>
        <input type="file" id="docFiles" multiple accept=".pdf,.txt,.md,.csv,.json" />
        <div class="row" style="margin-top:10px;">
          <button id="uploadBtn">è³‡æ–™ã‚’è¿½åŠ </button>
          <button id="refreshBtn" class="secondary">ä¸€è¦§æ›´æ–°</button>
        </div>
        <div class="muted" id="uploadStatus" style="margin-top:8px;"></div>
      </div>

      <div style="height:12px"></div>

      <h2>è¿½åŠ æ¸ˆã¿è³‡æ–™ä¸€è¦§</h2>
      <div class="muted" id="docHint">èª­ã¿è¾¼ã¿ä¸­...</div>
      <div style="height:8px"></div>
      <div id="docList"></div>
    </div>

    <!-- å³ï¼šãƒãƒ£ãƒƒãƒˆ -->
    <div class="card">
      <h1>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h1>
      <div class="muted" id="chatHint">è³‡æ–™ã‚’è¿½åŠ ã™ã‚‹ã¨ã€è³ªå•ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</div>

      <div style="height:10px"></div>

      <div class="chat" id="chat"></div>

      <div style="height:10px"></div>

      <div class="stack">
        <textarea id="query" placeholder="è³ªå•ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šã“ã®è³‡æ–™ã®è¦ç‚¹ã‚’3ã¤ã€‚çµè«–ã ã‘ã€‚ï¼‰"></textarea>
        <div class="row">
          <button id="sendBtn">é€ä¿¡</button>
          <button id="clearBtn" class="secondary">å±¥æ­´ã‚¯ãƒªã‚¢</button>
          <span class="muted">é€ä¿¡å…ˆ: <code id="endpoint"></code></span>
        </div>
        <div class="muted" id="status"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // ------------------------------------------------------------
  // 0) è¨­å®š
  // ------------------------------------------------------------
  const apiBaseEl = document.getElementById("apiBase");
  const endpointEl = document.getElementById("endpoint");

  const docFilesEl = document.getElementById("docFiles");
  const uploadBtn = document.getElementById("uploadBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const uploadStatus = document.getElementById("uploadStatus");

  const docListEl = document.getElementById("docList");
  const docHintEl = document.getElementById("docHint");

  const chatEl = document.getElementById("chat");
  const queryEl = document.getElementById("query");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");
  const statusEl = document.getElementById("status");
  const chatHintEl = document.getElementById("chatHint");

  function apiBase() {
    return (apiBaseEl.value || "").trim().replace(/\/+$/, "");
  }

  function setEndpointLabel() {
    endpointEl.textContent = apiBase() + "/chat";
  }

  function setStatus(text) {
    statusEl.textContent = text || "";
  }

  function addMsg(role, text) {
    const div = document.createElement("div");
    div.className = "msg " + role;
    div.textContent = (role === "me" ? "You: " : role === "bot" ? "Bot: " : "") + text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function addSys(text) {
    const div = document.createElement("div");
    div.className = "msg sys";
    div.textContent = text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  // ------------------------------------------------------------
  // 1) è³‡æ–™ä¸€è¦§
  // ------------------------------------------------------------
  async function refreshDocuments() {
    docHintEl.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
    docListEl.innerHTML = "";

    try {
      const res = await fetch(apiBase() + "/documents");
      if (!res.ok) throw new Error("documents API failed: " + res.status);
      const data = await res.json();
      const docs = data.documents || [];

      if (docs.length === 0) {
        docHintEl.textContent = "ã¾ã è³‡æ–™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšå·¦ã‹ã‚‰PDF/TXTã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚";
        sendBtn.disabled = true;
        chatHintEl.textContent = "è³‡æ–™ã‚’è¿½åŠ ã™ã‚‹ã¨ã€è³ªå•ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚";
        return;
      }

      docHintEl.textContent = "";
      const ul = document.createElement("ul");

      let anyIngested = false;
      for (const d of docs) {
        if (d.ingested) anyIngested = true;

        const li = document.createElement("li");
        const row = document.createElement("div");
        row.className = "docItem";

        const name = document.createElement("div");
        name.textContent = d.filename;

        const rightSide = document.createElement("div");
        rightSide.style.display = "flex";
        rightSide.style.gap = "8px";
        rightSide.style.alignItems = "center";

        const badge = document.createElement("span");
        badge.className = "badge " + (d.ingested ? "ok" : "ng");
        badge.textContent = d.ingested ? "READY" : "PENDING";

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "å‰Šé™¤";
        deleteBtn.className = "secondary";
        deleteBtn.style.padding = "4px 8px";
        deleteBtn.style.fontSize = "11px";
        deleteBtn.onclick = async () => {
          if (!confirm(`${d.filename} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
          await deleteDocument(d.sha);
        };

        rightSide.appendChild(badge);
        rightSide.appendChild(deleteBtn);

        row.appendChild(name);
        row.appendChild(rightSide);
        li.appendChild(row);
        ul.appendChild(li);
      }

      docListEl.appendChild(ul);

      // è³‡æ–™ãŒREADYãªã‚‰è³ªå•è§£ç¦
      sendBtn.disabled = !anyIngested;
      chatHintEl.textContent = anyIngested
        ? "è¿½åŠ æ¸ˆã¿è³‡æ–™ã‚’å‚ç…§ã—ã¦å›ç­”ã—ã¾ã™ã€‚è³ªå•ã—ã¦ãã ã•ã„ã€‚"
        : "è³‡æ–™ã¯ã‚ã‚Šã¾ã™ãŒã€ã¾ã å–ã‚Šè¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ä¸€è¦§æ›´æ–°ã—ã¦ãã ã•ã„ã€‚";

    } catch (e) {
      docHintEl.textContent = "è³‡æ–™ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message;
      sendBtn.disabled = true;
    }
  }

  // ------------------------------------------------------------
  // 1.5) ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‰Šé™¤ï¼ˆ/documents/{sha}ï¼‰
  // ------------------------------------------------------------
  async function deleteDocument(sha) {
    try {
      const res = await fetch(apiBase() + "/documents/" + sha, {
        method: "DELETE"
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error("delete failed: HTTP " + res.status + " " + t);
      }

      const data = await res.json();
      addSys(data.message || "å‰Šé™¤ã—ã¾ã—ãŸ");
      await refreshDocuments();

    } catch (e) {
      alert("å‰Šé™¤å¤±æ•—: " + e.message);
    }
  }

  // ------------------------------------------------------------
  // 2) è³‡æ–™ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆ/documentsï¼‰
  // ------------------------------------------------------------
  async function uploadDocuments() {
    const files = Array.from(docFilesEl.files || []);
    if (files.length === 0) {
      uploadStatus.textContent = "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
      return;
    }

    uploadBtn.disabled = true;
    uploadStatus.textContent = "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼†å–ã‚Šè¾¼ã¿ä¸­...ï¼ˆåˆå›ã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰";

    try {
      const form = new FormData();
      for (const f of files) form.append("files", f);

      const res = await fetch(apiBase() + "/documents", {
        method: "POST",
        body: form
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error("upload failed: HTTP " + res.status + " " + t);
      }

      const data = await res.json();
      const msg =
        `å®Œäº†: æ–°è¦å–ã‚Šè¾¼ã¿ ${data.newly_ingested?.length || 0} / æ—¢å­˜ã‚¹ã‚­ãƒƒãƒ— ${data.already_ingested?.length || 0}`;
      uploadStatus.textContent = msg;

      // é¸æŠã‚’ã‚¯ãƒªã‚¢
      docFilesEl.value = "";

      // ä¸€è¦§æ›´æ–°
      await refreshDocuments();
      addSys("è³‡æ–™ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚å³å´ã§è³ªå•ã§ãã¾ã™ã€‚");

    } catch (e) {
      uploadStatus.textContent = "å¤±æ•—: " + e.message;
    } finally {
      uploadBtn.disabled = false;
    }
  }

  // ------------------------------------------------------------
  // 3) ãƒãƒ£ãƒƒãƒˆé€ä¿¡ï¼ˆ/chatï¼‰
  // ------------------------------------------------------------
  async function sendChat() {
    const q = (queryEl.value || "").trim();
    if (!q) return;

    addMsg("me", q);
    queryEl.value = "";
    sendBtn.disabled = true;
    setStatus("é€ä¿¡ä¸­...");

    try {
      const res = await fetch(apiBase() + "/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ query: q })
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error("chat failed: HTTP " + res.status + " " + t);
      }

      const data = await res.json();
      addMsg("bot", data.answer || JSON.stringify(data));
      setStatus("å®Œäº†");

    } catch (e) {
      addMsg("bot", "ã‚¨ãƒ©ãƒ¼: " + e.message);
      setStatus("ã‚¨ãƒ©ãƒ¼");
    } finally {
      // è³‡æ–™ãŒã‚ã‚‹æ™‚ã®ã¿é€ä¿¡å¯èƒ½ã«æˆ»ã™
      await refreshDocuments();
    }
  }

  // ------------------------------------------------------------
  // 4) ã‚¤ãƒ™ãƒ³ãƒˆ
  // ------------------------------------------------------------
  uploadBtn.addEventListener("click", uploadDocuments);
  refreshBtn.addEventListener("click", refreshDocuments);

  sendBtn.addEventListener("click", sendChat);
  queryEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendChat();
    }
  });

  clearBtn.addEventListener("click", () => {
    chatEl.innerHTML = "";
    addSys("å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚");
  });

  apiBaseEl.addEventListener("change", () => {
    setEndpointLabel();
    refreshDocuments();
  });
  apiBaseEl.addEventListener("keyup", () => {
    setEndpointLabel();
  });

  // åˆæœŸåŒ–
  setEndpointLabel();
  addSys("å·¦ã§è³‡æ–™ã‚’è¿½åŠ  â†’ å³ã§è³ªå•ã€ã®é †ã§ä½¿ã„ã¾ã™ã€‚");
  refreshDocuments();
</script>
</body>
</html>
